<%- include("../partials/head") %>

<nav class="navbar navbar-expand-lg bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand brand-accent" href="/">KMITL NEW</a>
    <div class="navbar-nav">
      <a class="nav-link" href="/user/rumours">ผู้ใช้ทั่วไป</a>
      <a class="nav-link" href="/reviewer">ผู้ตรวจสอบ</a>
      <a class="nav-link" href="/summary">สรุปผล</a>
    </div>
    <div class="navbar-nav ms-auto">
      <% if (currentUser) { %>
        <span class="navbar-text me-3">
          <%= currentUser.name %> (<%= currentUser.role === 'reviewer' ? 'ผู้ตรวจสอบ' : 'ผู้ใช้ทั่วไป' %>)
        </span>
        <form method="post" action="/logout" class="d-inline">
          <button class="btn btn-sm btn-outline-secondary" type="submit">ออกจากระบบ</button>
        </form>
      <% } else { %>
        <a class="nav-link" href="/login">เข้าสู่ระบบ</a>
      <% } %>
    </div>
  </div>
</nav>

<main class="container py-4">
  <h1 class="mb-3">รายละเอียดข่าวลือ</h1>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <!-- การ์ดรายละเอียดข่าว -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><%= rumour.title %></h5>
      <p class="card-text">รหัสข่าวลือ: <strong><%= rumour.id %></strong></p>
      <p class="card-text">แหล่งที่มา: <%= rumour.source %></p>
      <p class="card-text">วันที่สร้าง: <%= rumour.created_at %></p>
      <p class="card-text">คะแนนความน่าเชื่อถือ: <%= rumour.credibility_score %></p>
      <p class="card-text">
        สถานะ:
        <span class="badge <%= rumour.status === 'panic' ? 'bg-danger' : 'bg-secondary' %>">
          <%= rumour.status %>
        </span>
      </p>
      <p class="card-text">จำนวนรายงาน: <%= rumour.report_count || 0 %></p>
      <p class="card-text">ผลการตรวจสอบ: <%= rumour.verified_status %></p>
    </div>
  </div>

  <!-- ซ้าย: ฟอร์มรายงาน / ขวา: รายงานทั้งหมด -->
  <div class="row g-4">
    <div class="col-lg-6">
      <h4>รายงานข่าวลือ</h4>
      <% if (rumour.verified_status !== 'unverified') { %>
        <div class="alert alert-warning">ข่าวลือนี้ถูกตรวจสอบแล้ว จึงไม่สามารถรายงานเพิ่มได้</div>
      <% } %>
      <form method="post" action="/user/rumours/<%= rumour.id %>/reports" class="card card-body">
        <div class="mb-3">
          <label class="form-label">ผู้รายงาน</label>
          <div class="form-control-plaintext">
            <strong><%= currentUser ? currentUser.name : 'ไม่ทราบผู้ใช้' %></strong>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">ประเภทรายงาน</label>
          <select class="form-select" name="reportType" required>
            <option value="distortion">บิดเบือน (บิดข้อเท็จจริง)</option>
            <option value="incitement">ปลุกปั่น (ชวนให้ตื่นตระหนก)</option>
            <option value="false_info">ข้อมูลเท็จ (ไม่จริง)</option>
          </select>
          <div class="form-text">เลือกประเภทให้ตรงกับลักษณะข่าวลือ</div>
        </div>
        <button class="btn btn-primary" type="submit">บันทึกรายงาน</button>
      </form>
    </div>

    <div class="col-lg-6">
      <h4>รายการรายงานทั้งหมด</h4>
      <ul class="list-group">
        <% if (reports.length === 0) { %>
          <li class="list-group-item">ยังไม่มีรายงาน</li>
        <% } %>
        <% const reportLabels = { distortion: 'บิดเบือน', incitement: 'ปลุกปั่น', false_info: 'ข้อมูลเท็จ' }; %>
        <% const roleLabels = { user: 'ผู้ใช้ทั่วไป', reviewer: 'ผู้ตรวจสอบ' }; %>
        <% reports.forEach(rep => { %>
          <li class="list-group-item">
            <div class="report-row">
              <div class="report-left">
                <strong class="report-name"><%= rep.reporter_name %></strong>
                <span class="role-badge role-<%= rep.reporter_role %>">
                  <%= roleLabels[rep.reporter_role] || rep.reporter_role || '' %>
                </span>
              </div>
              <span class="report-badge report-<%= rep.report_type %>">
                <%= reportLabels[rep.report_type] || rep.report_type %>
              </span>
              <small class="text-muted report-time"><%= rep.reported_at %></small>
            </div>
          </li>
        <% }) %>
      </ul>
    </div>
  </div>
</main>

<%- include("../partials/foot") %>
